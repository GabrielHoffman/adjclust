library("adjclust")
library("snpStats")

context("Ascending compatibility of the adjclust algorithm")

test_that("snpClust gives results identical to those of adjclust 0.3.0", {

  data("res_adjclust_0.3.0", package = "adjclust")
  prevfit <- res_adjclust_0.3.0
  
  data("ld.example", package = "snpStats")
  p <- ncol(ceph.1mb)
  nSamples <- nrow(ceph.1mb)
  h <- 100
  ceph.1mb[4,286]@.Data[1,1] <- as.raw(3) ## to avoid NaNs
  ld.ceph <- ld(ceph.1mb, depth = h, stats = "R.squared")
  ld.ceph <- round(ld.ceph, digits = 10)
  
  #case1: Input belongs to class Matrix::dgCMatrix generated by snpStats::ld function
  fit1 <- snpClust(ld.ceph, h = 100)
  expect_equal(fit1$merge, prevfit$merge)
  expect_equal(fit1$height, prevfit$height)
    
  #case2: Input belongs to class snpStats::SnpMatrix
  fit2 <- snpClust(ceph.1mb, h = 100, stats = "R.squared")  
  expect_equal(fit2$merge, prevfit$merge)
  expect_equal(fit2$height, prevfit$height)  
  
  #case3:Input belongs class base::matrix
  ceph.1mb <- as.matrix(ceph.1mb)
  fit3 <- snpClust(ceph.1mb, h = 100, stats = "R.squared")  
  expect_equal(fit3$merge, prevfit$merge)
  expect_equal(fit3$height, prevfit$height)
  
  #case4: default h
  fit4 <- snpClust(ld.ceph, ncol(ceph.1mb) - 1)
  fit5 <- snpClust(ld.ceph)
  fit6 <- snpClust(ceph.1mb, stats = "R.squared")
  expect_equal(fit4$merge, fit5$merge)
  expect_equal(fit4$height, fit5$height)
  expect_equal(fit4$merge, fit6$merge)
  # expect_equal(fit4$height, fit6$height) ## fix it!
})
